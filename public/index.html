<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mattress Overstock ‚Äî Delivery Notifications</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: #080c14; color: #e2e8f0; min-height: 100vh; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    header { border-bottom: 1px solid #1e293b; padding: 16px 28px; display: flex; align-items: center; justify-content: space-between; background: #0b1120; }
    .logo { display: flex; align-items: center; gap: 14px; }
    .logo-icon { width: 40px; height: 40px; border-radius: 8px; object-fit: contain; }
    .logo-text h1 { font-size: 16px; font-weight: 700; letter-spacing: -0.3px; }
    .logo-text span { font-size: 11px; color: #64748b; letter-spacing: 0.5px; }
    .connections { display: flex; gap: 12px; }
    .conn-badge { display: flex; align-items: center; gap: 8px; padding: 6px 14px; border-radius: 8px; background: #0f172a; border: 1px solid #1e293b; font-size: 12px; }
    .conn-dot { width: 8px; height: 8px; border-radius: 50%; }
    .conn-dot.live { background: #2dd4bf; animation: pulse 2s infinite; }
    .conn-dot.down { background: #ef4444; }
    .conn-label { color: #94a3b8; font-weight: 500; }
    .conn-status { font-weight: 600; font-size: 11px; text-transform: uppercase; }
    .conn-status.live { color: #2dd4bf; }
    .conn-status.down { color: #ef4444; }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(45,212,191,0.4); } 50% { box-shadow: 0 0 0 6px rgba(45,212,191,0); } }
    nav { border-bottom: 1px solid #1e293b; padding: 0 28px; background: #0b1120; display: flex; }
    nav button { padding: 14px 22px; font-size: 13px; font-weight: 600; color: #64748b; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; letter-spacing: 0.2px; transition: all 0.2s; font-family: inherit; }
    nav button.active { color: #2dd4bf; border-bottom-color: #2dd4bf; }
    nav button:hover { color: #94a3b8; }
    main { padding: 24px 28px; max-width: 1200px; margin: 0 auto; }
    .stats { display: flex; gap: 14px; margin-bottom: 28px; flex-wrap: wrap; }
    .stat-card { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 20px 22px; flex: 1; min-width: 140px; }
    .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px; color: #64748b; margin-bottom: 8px; font-weight: 600; }
    .stat-value { font-size: 32px; font-weight: 700; line-height: 1; font-family: 'JetBrains Mono', monospace; }
    .stat-sub { font-size: 11px; color: #475569; margin-top: 6px; }
    .panel { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 18px; }
    .panel h3 { font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin-bottom: 14px; }
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: #64748b; border-bottom: 1px solid #1e293b; }
    td { padding: 14px 16px; border-bottom: 1px solid #1e293b22; }
    tr:hover { background: #1e293b33; }
    .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; }
    .badge-sent { color: #2dd4bf; background: rgba(45,212,191,0.12); border: 1px solid rgba(45,212,191,0.13); }
    .badge-pending { color: #fbbf24; background: rgba(251,191,36,0.12); border: 1px solid rgba(251,191,36,0.13); }
    .badge-failed { color: #ef4444; background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.13); }
    .badge-delivered { color: #818cf8; background: rgba(129,140,248,0.12); border: 1px solid rgba(129,140,248,0.13); }
    .badge-cancelled { color: #64748b; background: rgba(100,116,139,0.12); border: 1px solid rgba(100,116,139,0.13); text-decoration: line-through; }
    .badge-rescheduling { color: #fbbf24; background: rgba(251,191,36,0.12); border: 1px solid rgba(251,191,36,0.13); }
    .store-dot { display: inline-flex; align-items: center; gap: 5px; font-size: 12px; color: #94a3b8; }
    .store-dot span { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .btn { padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: opacity 0.2s; font-family: inherit; }
    .btn:hover { opacity: 0.85; }
    .btn-primary { background: linear-gradient(135deg, #2dd4bf, #14b8a6); color: #042f2e; }
    .btn-outline { background: transparent; border: 1px solid #2dd4bf; color: #2dd4bf; padding: 5px 12px; font-size: 11px; }
    .btn-danger { background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 5px 12px; font-size: 11px; }
    .log-entry { padding: 10px 0; border-bottom: 1px solid #1e293b22; display: flex; gap: 12px; align-items: flex-start; }
    .log-dot { width: 7px; height: 7px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
    .log-event { font-size: 12px; font-weight: 600; color: #cbd5e1; }
    .log-time { font-size: 11px; color: #475569; font-family: 'JetBrains Mono', monospace; }
    .log-detail { font-size: 12px; color: #64748b; margin-top: 2px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    .workflow { display: flex; align-items: center; justify-content: center; gap: 0; flex-wrap: wrap; padding: 10px 0; }
    .workflow-step { text-align: center; padding: 14px 16px; background: #1e293b44; border-radius: 10px; border: 1px solid #1e293b; min-width: 120px; }
    .workflow-step .icon { font-size: 24px; margin-bottom: 6px; }
    .workflow-step .label { font-size: 12px; font-weight: 700; color: #e2e8f0; }
    .workflow-step .sub { font-size: 10px; color: #64748b; margin-top: 2px; }
    .workflow-arrow { width: 40px; height: 2px; background: linear-gradient(90deg, #2dd4bf44, #818cf844); margin: 0 -2px; }
    .toast { position: fixed; top: 20px; right: 20px; z-index: 999; background: #166534; color: #bbf7d0; padding: 12px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; box-shadow: 0 8px 30px rgba(0,0,0,0.4); transform: translateX(120%); transition: transform 0.3s ease; }
    .toast.show { transform: translateX(0); }
    select { padding: 8px 12px; border-radius: 8px; border: 1px solid #1e293b; background: #0f172a; color: #e2e8f0; font-size: 12px; font-weight: 500; cursor: pointer; font-family: inherit; }
    select:focus { outline: none; border-color: #2dd4bf; }
    .empty { padding: 40px; text-align: center; color: #475569; }
    .loading { text-align: center; padding: 40px; color: #64748b; }
    @media (max-width: 768px) {
      .grid-2 { grid-template-columns: 1fr; }
      .stats { flex-direction: column; }
      .workflow { flex-direction: column; }
      .workflow-arrow { width: 2px; height: 20px; }
    }
  </style>
</head>
<body>
  <div id="toast" class="toast"></div>
  <div id="login-overlay" style="display:none;position:fixed;inset:0;background:#080c14;z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#0f172a;border:1px solid #1e293b;border-radius:16px;padding:40px;max-width:380px;width:100%;text-align:center;">
      <img src="/mascot.png" alt="MO" style="width:60px;height:60px;border-radius:12px;margin-bottom:16px;">
      <h2 style="font-size:18px;font-weight:700;margin-bottom:6px;">Mattress Overstock</h2>
      <p style="color:#64748b;font-size:13px;margin-bottom:24px;">Enter admin password to continue</p>
      <input id="login-password" type="password" placeholder="Password" style="width:100%;padding:12px 16px;border-radius:8px;border:1px solid #1e293b;background:#0b1120;color:#e2e8f0;font-size:14px;font-family:inherit;margin-bottom:12px;outline:none;" onkeydown="if(event.key==='Enter')doLogin()">
      <button onclick="doLogin()" class="btn btn-primary" style="width:100%;padding:12px;font-size:14px;">Sign In</button>
      <p id="login-error" style="color:#ef4444;font-size:12px;margin-top:12px;display:none;">Invalid password</p>
    </div>
  </div>
  <header>
    <div class="logo">
      <img src="/mascot.png" alt="MO Mascot" class="logo-icon">
      <div class="logo-text">
        <h1>Mattress Overstock</h1>
        <span>DELIVERY NOTIFICATION HUB</span>
      </div>
    </div>
    <div class="connections">
      <div class="conn-badge">
        <div id="spoke-dot" class="conn-dot down"></div>
        <span class="conn-label">Spoke Dispatch</span>
        <span id="spoke-status" class="conn-status down">Checking</span>
      </div>
      <div class="conn-badge">
        <div id="quo-dot" class="conn-dot down"></div>
        <span class="conn-label">Quo</span>
        <span id="quo-status" class="conn-status down">Checking</span>
      </div>
      <button id="logout-btn" onclick="doLogout()" class="conn-badge" style="cursor:pointer;border:1px solid #334155;background:#1e293b;color:#94a3b8;font-size:12px;font-weight:600;font-family:inherit;display:none;">Logout</button>
    </div>
  </header>
  <nav>
    <button class="active" data-tab="overview">Overview</button>
    <button data-tab="notifications">Notifications</button>
    <button data-tab="reports">Reports</button>
    <button data-tab="sale-reviews">Sale Reviews</button>
    <button data-tab="settings">Settings</button>
  </nav>
  <main>
    <div id="tab-overview">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <div>
          <h2 style="font-size:22px;font-weight:700;letter-spacing:-0.5px" id="overview-title">Next Delivery Day</h2>
          <p style="color:#64748b;font-size:13px;margin-top:4px" id="overview-subtitle">Loading...</p>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="btn btn-outline" id="toggle-view-btn" onclick="toggleStatsView()" style="font-size:11px">Show All-Time</button>
          <button class="btn btn-primary" id="send-all-btn" style="display:none" onclick="sendAllPending()">Send All Pending (<span id="pending-badge">0</span>)</button>
        </div>
      </div>
      <div class="stats" id="stats-container">
        <div class="stat-card"><div class="stat-label">Sent</div><div class="stat-value" id="stat-sent" style="color:#2dd4bf">‚Äî</div><div class="stat-sub" id="sub-sent">SMS delivered</div></div>
        <div class="stat-card"><div class="stat-label">Pending</div><div class="stat-value" id="stat-pending" style="color:#fbbf24">‚Äî</div><div class="stat-sub" id="sub-pending">Awaiting send</div></div>
        <div class="stat-card"><div class="stat-label">Confirmed</div><div class="stat-value" id="stat-confirmed" style="color:#818cf8">‚Äî</div><div class="stat-sub" id="sub-confirmed">Replied YES</div></div>
        <div class="stat-card"><div class="stat-label">Declined</div><div class="stat-value" id="stat-declined" style="color:#ef4444">‚Äî</div><div class="stat-sub" id="sub-declined">Replied NO</div></div>
      </div>
      <div class="grid-2" style="margin-bottom:18px">
        <div class="panel" style="border-left:3px solid #818cf8">
          <h3 style="display:flex;justify-content:space-between;align-items:center"><span>Tomorrow's Queue</span><span class="mono" id="tomorrow-date" style="font-size:11px;color:#64748b;text-transform:none;letter-spacing:0">‚Äî</span></h3>
          <div style="display:flex;gap:20px;margin-top:12px">
            <div><div style="font-size:28px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#818cf8" id="tomorrow-total">0</div><div style="font-size:11px;color:#64748b;margin-top:2px">Total stops</div></div>
            <div><div style="font-size:28px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#fbbf24" id="tomorrow-pending">0</div><div style="font-size:11px;color:#64748b;margin-top:2px">Pending send</div></div>
            <div><div style="font-size:28px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#2dd4bf" id="tomorrow-sent">0</div><div style="font-size:11px;color:#64748b;margin-top:2px">Already sent</div></div>
          </div>
        </div>
        <div class="panel" style="border-left:3px solid #2dd4bf">
          <h3>Scheduler</h3>
          <div style="margin-top:10px;font-size:13px;line-height:2">
            <div style="display:flex;justify-content:space-between"><span style="color:#64748b">Status</span><span id="sched-status" style="font-weight:600;color:#2dd4bf">Active</span></div>
            <div style="display:flex;justify-content:space-between"><span style="color:#64748b">Customer SMS</span><span class="mono" id="sched-next" style="font-size:12px;color:#e2e8f0">‚Äî</span></div>
            <div style="display:flex;justify-content:space-between"><span style="color:#64748b">Staff summary</span><span class="mono" id="sched-summary" style="font-size:12px;color:#e2e8f0">9:00 PM EST</span></div>
            <div style="display:flex;justify-content:space-between"><span style="color:#64748b">Today</span><span id="sched-today" style="font-size:12px;color:#e2e8f0">‚Äî</span></div>
            <div style="display:flex;gap:8px;margin-top:6px">
              <button class="btn btn-outline" onclick="triggerManualSend()" style="flex:1;text-align:center;font-size:11px">‚ö° Send Now</button>
              <button class="btn btn-outline" onclick="triggerStaffSummary()" style="flex:1;text-align:center;font-size:11px">üìã Summary</button>
              <button class="btn btn-outline" id="sync-btn" onclick="triggerSync()" style="flex:1;text-align:center;font-size:11px">üîÑ Sync Routes</button>
            </div>
          </div>
        </div>
      </div>
      <div class="grid-2">
        <div class="panel">
          <h3 style="display:flex;justify-content:space-between;align-items:center"><span>Recent Activity</span><span style="font-size:10px;color:#475569;text-transform:none;letter-spacing:0;font-weight:400">Last 24 hours</span></h3>
          <div id="activity-log"><div class="loading">Loading activity...</div></div>
        </div>
        <div class="panel">
          <h3>Automation Workflow</h3>
          <div class="workflow">
            <div class="workflow-step"><div class="icon">üì¶</div><div class="label">Spoke Dispatch</div><div class="sub">Route ‚Üí webhook</div></div>
            <div class="workflow-arrow"></div>
            <div class="workflow-step"><div class="icon">üîÑ</div><div class="label">Sync & Import</div><div class="sub">Auto every 15 min</div></div>
            <div class="workflow-arrow"></div>
            <div class="workflow-step"><div class="icon">‚è∞</div><div class="label">6 PM Send</div><div class="sub">Daily batch SMS</div></div>
            <div class="workflow-arrow"></div>
            <div class="workflow-step"><div class="icon">üí¨</div><div class="label">Customer Reply</div><div class="sub">YES / NO / STOP</div></div>
          </div>
          <div style="margin-top:14px;padding:12px;background:#1e293b44;border-radius:8px;font-size:11px;color:#64748b;line-height:1.8">
            <strong style="color:#94a3b8">6 PM:</strong> Customer texts sent Mon‚ÄìFri for next-day deliveries<br>
            <strong style="color:#94a3b8">9 PM:</strong> Staff summary sent to scheduling team<br>
            <strong style="color:#94a3b8">YES:</strong> Confirmed ‚Üí Google review sent after delivery<br>
            <strong style="color:#94a3b8">NO:</strong> AI reschedule conversation starts<br>
            <strong style="color:#94a3b8">Sync:</strong> Every 15 min (8‚Äì4), every 5 min (4‚Äì6)
          </div>
        </div>
      </div>
    </div>
    <div id="tab-notifications" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
        <h2 style="font-size:20px;font-weight:700">All Notifications</h2>
        <div style="display:flex;gap:10px">
          <select id="filter-store" onchange="loadNotifications()"><option value="">All Stores</option><option value="lexington">Nicholasville Rd</option><option value="georgetown">Georgetown</option><option value="somerset">Somerset</option><option value="london">London</option></select>
          <select id="filter-status" onchange="loadNotifications()"><option value="">All Status</option><option value="sent">Sent</option><option value="pending">Pending</option><option value="failed">Failed</option><option value="delivered">Delivered</option><option value="cancelled">Cancelled</option><option value="rescheduling">Rescheduling</option></select>
        </div>
      </div>
      <div class="panel"><div class="table-wrap"><table><thead><tr><th>Customer</th><th>Store</th><th>Delivery Date</th><th>Time Window</th><th>Product</th><th>Status</th><th>Response</th><th>Review</th><th>Actions</th></tr></thead><tbody id="notifications-table"><tr><td colspan="9" class="loading">Loading notifications...</td></tr></tbody></table></div></div>
    </div>
    <div id="tab-reports" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <div><h2 style="font-size:22px;font-weight:700;letter-spacing:-0.5px">Reports & Analytics</h2><p style="color:#64748b;font-size:13px;margin-top:4px">Performance metrics across all stores</p></div>
        <select id="chart-days" onchange="loadCharts()" style="padding:8px 14px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#94a3b8;font-size:13px;font-family:inherit;cursor:pointer"><option value="7">Last 7 days</option><option value="14" selected>Last 14 days</option><option value="30">Last 30 days</option></select>
      </div>
      <div class="stats" id="report-kpis">
        <div class="stat-card"><div class="stat-label">Confirmation Rate</div><div class="stat-value" id="kpi-confirm-rate" style="color:#2dd4bf">‚Äî</div><div class="stat-sub" id="kpi-confirm-sub">of sent messages</div></div>
        <div class="stat-card"><div class="stat-label">Decline Rate</div><div class="stat-value" id="kpi-decline-rate" style="color:#ef4444">‚Äî</div><div class="stat-sub" id="kpi-decline-sub">need rescheduling</div></div>
        <div class="stat-card"><div class="stat-label">Reviews Sent</div><div class="stat-value" id="kpi-reviews" style="color:#fbbf24">‚Äî</div><div class="stat-sub" id="kpi-reviews-sub">Google review requests</div></div>
        <div class="stat-card"><div class="stat-label">No Reply</div><div class="stat-value" id="kpi-noreply" style="color:#64748b">‚Äî</div><div class="stat-sub" id="kpi-noreply-sub">no response yet</div></div>
      </div>
      <div class="grid-2"><div class="panel"><h3>Daily Volume</h3><div style="position:relative;height:260px"><canvas id="chart-daily"></canvas></div></div><div class="panel"><h3>Customer Responses</h3><div style="position:relative;height:260px"><canvas id="chart-responses"></canvas></div></div></div>
      <div class="grid-2"><div class="panel"><h3>Deliveries by Store</h3><div style="position:relative;height:260px"><canvas id="chart-stores"></canvas></div></div><div class="panel"><h3>Delivery Time Windows</h3><div style="position:relative;height:260px"><canvas id="chart-windows"></canvas></div></div></div>
      <div class="panel"><h3>Store Performance</h3><table><thead><tr><th>Store</th><th>Deliveries</th><th>Confirmed</th><th>Declined</th><th>Confirm %</th><th>Reviews Sent</th></tr></thead><tbody id="store-perf-table"><tr><td colspan="6" class="loading">Loading...</td></tr></tbody></table></div>
    </div>
    <!-- ‚ïê‚ïê‚ïê NEW: Sale Reviews Tab ‚ïê‚ïê‚ïê -->
    <div id="tab-sale-reviews" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <div>
          <h2 style="font-size:22px;font-weight:700;letter-spacing:-0.5px">Day-of-Sale Reviews</h2>
          <p style="color:#64748b;font-size:13px;margin-top:4px">Send AI-generated review requests at point of sale ‚Äî compare with delivery-day reviews</p>
        </div>
      </div>
      <!-- Entry Form -->
      <div class="panel" style="border-left:3px solid #fbbf24">
        <h3 style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">‚≠ê</span> New Sale Review Request</h3>
        <p style="font-size:12px;color:#64748b;margin-bottom:16px">Enter customer details to send an AI-generated Google review request via SMS. Claude generates a unique, personalized message for each customer.</p>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px;align-items:end">
          <div>
            <label style="display:block;font-size:11px;font-weight:600;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Customer Name</label>
            <input id="sr-name" type="text" placeholder="John Smith" style="width:100%;padding:10px 14px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#e2e8f0;font-size:13px;font-family:inherit">
          </div>
          <div>
            <label style="display:block;font-size:11px;font-weight:600;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Phone Number</label>
            <input id="sr-phone" type="tel" placeholder="(859) 555-0142" style="width:100%;padding:10px 14px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#e2e8f0;font-size:13px;font-family:inherit">
          </div>
          <div>
            <label style="display:block;font-size:11px;font-weight:600;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Sale Number</label>
            <input id="sr-sale" type="text" placeholder="20162800" style="width:100%;padding:10px 14px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#e2e8f0;font-size:13px;font-family:'JetBrains Mono',monospace">
          </div>
          <button id="sr-submit-btn" class="btn btn-primary" onclick="submitSaleReview()" style="padding:10px 20px;white-space:nowrap">
            ‚≠ê Send Review Request
          </button>
        </div>
        <div style="margin-top:10px;font-size:11px;color:#475569">
          <strong style="color:#64748b">Sale prefix:</strong>
          <span style="color:#c084fc">2</span>=Nicholasville Rd &nbsp;
          <span style="color:#38bdf8">3</span>=Georgetown &nbsp;
          <span style="color:#818cf8">4</span>=Somerset &nbsp;
          <span style="color:#f472b6">5</span>=London &nbsp;
          <span style="color:#64748b">1</span>=Other (no review)
        </div>
      </div>
      <!-- Comparison KPIs -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px">
        <div class="panel" style="border-top:3px solid #fbbf24">
          <h3 style="font-size:14px;color:#fbbf24;margin-bottom:14px">üìç Day-of-Sale Reviews</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
            <div style="text-align:center"><div style="font-size:28px;font-weight:800;color:#fbbf24" id="sr-sale-total">‚Äî</div><div style="font-size:11px;color:#64748b">Sent</div></div>
            <div style="text-align:center"><div style="font-size:28px;font-weight:800;color:#2dd4bf" id="sr-sale-clicked">‚Äî</div><div style="font-size:11px;color:#64748b">Clicked</div></div>
            <div style="text-align:center"><div style="font-size:28px;font-weight:800;color:#e2e8f0" id="sr-sale-rate">‚Äî</div><div style="font-size:11px;color:#64748b">Click Rate</div></div>
          </div>
        </div>
        <div class="panel" style="border-top:3px solid #818cf8">
          <h3 style="font-size:14px;color:#818cf8;margin-bottom:14px">üöö Delivery-Day Reviews</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
            <div style="text-align:center"><div style="font-size:28px;font-weight:800;color:#818cf8" id="sr-delivery-total">‚Äî</div><div style="font-size:11px;color:#64748b">Sent</div></div>
            <div style="text-align:center"><div style="font-size:28px;font-weight:800;color:#2dd4bf" id="sr-delivery-clicked">‚Äî</div><div style="font-size:11px;color:#64748b">Clicked</div></div>
            <div style="text-align:center"><div style="font-size:28px;font-weight:800;color:#e2e8f0" id="sr-delivery-rate">‚Äî</div><div style="font-size:11px;color:#64748b">Click Rate</div></div>
          </div>
        </div>
      </div>
      <!-- Comparison Chart -->
      <div class="panel" style="margin-top:18px">
        <h3>Click-Through Comparison</h3>
        <div style="position:relative;height:260px"><canvas id="chart-review-comparison"></canvas></div>
      </div>
      <!-- Sale Reviews Table -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:24px;margin-bottom:14px">
        <h3 style="font-size:16px;font-weight:700">Recent Sale Reviews</h3>
        <select id="sr-filter-store" onchange="loadSaleReviews()" style="padding:8px 12px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#e2e8f0;font-size:12px;font-weight:500;cursor:pointer;font-family:inherit">
          <option value="">All Stores</option>
          <option value="lexington">Nicholasville Rd</option>
          <option value="georgetown">Georgetown</option>
          <option value="somerset">Somerset</option>
          <option value="london">London</option>
        </select>
      </div>
      <div class="panel">
        <div class="table-wrap"><table><thead><tr><th>Customer</th><th>Store</th><th>Sale #</th><th>AI Message</th><th>Status</th><th>Clicked</th><th>Sent At</th><th>Actions</th></tr></thead><tbody id="sr-table"><tr><td colspan="8" class="loading">Loading sale reviews...</td></tr></tbody></table></div>
      </div>
    </div>
    <!-- ‚ïê‚ïê‚ïê END Sale Reviews Tab ‚ïê‚ïê‚ïê -->
    <div id="tab-settings" style="display:none">
      <h2 style="font-size:20px;font-weight:700;margin-bottom:20px">Configuration</h2>
      <div class="panel"><h3>API Connections</h3><div class="grid-2"><div style="padding:16px;border-radius:10px;border:1px solid #1e293b;background:#1e293b22"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><strong style="font-size:14px">Spoke Dispatch</strong><span id="spoke-config-status" style="font-size:11px;font-weight:600">Checking...</span></div><div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:4px">Webhook URL</div><input readonly id="webhook-url" style="width:100%;padding:10px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#64748b;font-size:12px;font-family:'JetBrains Mono',monospace" value="Loading..."><div style="font-size:11px;color:#475569;margin-top:8px">Copy this URL into Spoke Dispatch ‚Üí Settings ‚Üí Integrations ‚Üí Webhooks</div></div><div style="padding:16px;border-radius:10px;border:1px solid #1e293b;background:#1e293b22"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><strong style="font-size:14px">Quo (SMS)</strong><span id="quo-config-status" style="font-size:11px;font-weight:600">Checking...</span></div><div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:4px">API Endpoint</div><input readonly value="https://api.quo.com/v1/messages" style="width:100%;padding:10px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#64748b;font-size:12px;font-family:'JetBrains Mono',monospace"><div style="font-size:11px;color:#475569;margin-top:8px">Set QUO_API_KEY and QUO_PHONE_NUMBER_ID in Railway environment variables</div></div></div></div>
      <div class="panel"><h3>Route Sync ‚Äî Tracked Plans</h3><p style="font-size:12px;color:#64748b;margin-bottom:12px">Manually register a plan if a webhook was missed.</p><div style="display:flex;gap:8px;margin-bottom:12px"><input id="plan-id-input" placeholder="Plan ID (e.g., plans/abc123 or just abc123)" style="flex:2;padding:8px 12px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#e2e8f0;font-size:12px;font-family:'JetBrains Mono',monospace"><input id="plan-date-input" type="date" style="flex:1;padding:8px 12px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#e2e8f0;font-size:12px"><button class="btn btn-outline" onclick="registerPlanFromUI()">Track Plan</button></div><div id="tracked-plans-list" style="max-height:150px;overflow-y:auto"><div style="color:#475569;font-size:12px">Loading...</div></div></div>
      <div class="panel"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><h3 style="margin-bottom:0">SMS Template</h3><button class="btn btn-outline" onclick="toggleTemplateEdit()">Edit Template</button></div><div id="template-display" style="padding:16px;background:#1e293b44;border-radius:8px;border:1px solid #1e293b;font-size:13px;color:#94a3b8;line-height:1.7">Loading...</div><div id="template-editor" style="display:none;margin-top:12px"><textarea id="template-input" rows="4" style="width:100%;padding:10px 14px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#e2e8f0;font-size:13px;font-family:'DM Sans',system-ui;resize:vertical;line-height:1.7"></textarea><div style="font-size:11px;color:#475569;line-height:1.6;margin-top:6px"><strong style="color:#64748b">Variables:</strong> {{customer_first}}, {{customer_last}}, {{date}}, {{time_window}}, {{driver}}, {{store}}, {{product}}, {{address}}, {{business_name}}</div><button class="btn btn-primary" style="margin-top:12px" onclick="saveTemplate()">Save Template</button></div></div>
    </div>
  </main>
  <script>
    const API = '';
    const AUTH_KEY = 'mo_admin_pwd';
    function getAuthHeaders() { const pwd = sessionStorage.getItem(AUTH_KEY); return pwd ? { 'Authorization': 'Bearer ' + pwd } : {}; }
    async function authFetch(url, opts = {}) { opts.headers = { ...opts.headers, ...getAuthHeaders() }; const res = await fetch(url, opts); if (res.status === 401) { showLoginScreen(); throw new Error('Unauthorized'); } return res; }
    function showLoginScreen() { document.getElementById('login-overlay').style.display = 'flex'; }
    function hideLoginScreen() { document.getElementById('login-overlay').style.display = 'none'; }
    async function doLogin() { const pwd = document.getElementById('login-password').value; if (!pwd) return; try { const res = await fetch(API + '/api/auth/verify', { method: 'POST', headers: { 'Authorization': 'Bearer ' + pwd } }); if (res.ok) { const data = await res.json(); if (data.valid) { sessionStorage.setItem(AUTH_KEY, pwd); document.getElementById('login-error').style.display = 'none'; document.getElementById('login-password').value = ''; hideLoginScreen(); document.getElementById('logout-btn').style.display = ''; initDashboard(); return; } } document.getElementById('login-error').style.display = ''; } catch (e) { document.getElementById('login-error').style.display = ''; } }
    function doLogout() { sessionStorage.removeItem(AUTH_KEY); showLoginScreen(); document.getElementById('logout-btn').style.display = 'none'; }
    async function checkAuth() { try { const res = await fetch(API + '/api/auth/verify', { method: 'POST', headers: getAuthHeaders() }); if (res.ok) { const data = await res.json(); if (data.valid) { if (sessionStorage.getItem(AUTH_KEY)) document.getElementById('logout-btn').style.display = ''; return true; } } sessionStorage.removeItem(AUTH_KEY); showLoginScreen(); return false; } catch (e) { return true; } }
    function initDashboard() { loadStats(); loadActivity(); checkConnections(); }
    let showAllTime = false;
    document.querySelectorAll('nav button').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('nav button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); document.querySelectorAll('main > div[id^="tab-"]').forEach(t => t.style.display = 'none'); document.getElementById('tab-' + btn.dataset.tab).style.display = ''; if (btn.dataset.tab === 'notifications') loadNotifications(); if (btn.dataset.tab === 'reports') loadCharts(); if (btn.dataset.tab === 'settings') loadSettings(); if (btn.dataset.tab === 'sale-reviews') { loadSaleReviews(); loadReviewComparison(); } }); });
    function showToast(msg) { const t = document.getElementById('toast'); t.textContent = '‚úì ' + msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
    const storeColors = { somerset: '#818cf8', london: '#f472b6', georgetown: '#38bdf8', lexington: '#c084fc', other: '#64748b', unknown: '#475569' };
    const storeNames = { somerset: 'Somerset', london: 'London', georgetown: 'Georgetown', lexington: 'Nicholasville Rd', other: 'Other', unknown: 'Unknown' };
    function storeDot(store) { const c = storeColors[store] || '#64748b'; const n = storeNames[store] || store || '‚Äî'; return `<span class="store-dot"><span style="background:${c}"></span>${n}</span>`; }
    function badge(status) { return `<span class="badge badge-${status}">${status}</span>`; }
    function formatDate(dateStr) { if (!dateStr) return '‚Äî'; const d = new Date(dateStr + 'T12:00:00'); return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }); }
    function toggleStatsView() { showAllTime = !showAllTime; document.getElementById('toggle-view-btn').textContent = showAllTime ? 'Show Next Delivery' : 'Show All-Time'; loadStats(); }
    async function loadStats() { try { const res = await authFetch(API + '/api/stats'); const data = await res.json(); const nd = data.nextDelivery || {}; if (showAllTime) { const a = data.allTime; document.getElementById('stat-sent').textContent = a.sent || 0; document.getElementById('stat-pending').textContent = a.pending || 0; document.getElementById('stat-confirmed').textContent = a.confirmedYes || 0; document.getElementById('stat-declined').textContent = a.declinedNo || 0; document.getElementById('sub-sent').textContent = 'Total SMS sent'; document.getElementById('sub-pending').textContent = 'Awaiting send'; document.getElementById('sub-confirmed').textContent = 'Total confirmed'; document.getElementById('sub-declined').textContent = 'Total declined'; document.getElementById('overview-subtitle').textContent = `${a.total} total notifications processed`; } else { document.getElementById('stat-sent').textContent = nd.sent || 0; document.getElementById('stat-pending').textContent = nd.pending || 0; document.getElementById('stat-confirmed').textContent = nd.confirmed || 0; document.getElementById('stat-declined').textContent = nd.declined || 0; document.getElementById('sub-sent').textContent = 'SMS sent'; document.getElementById('sub-pending').textContent = 'Awaiting 6 PM send'; document.getElementById('sub-confirmed').textContent = 'Replied YES'; document.getElementById('sub-declined').textContent = nd.rescheduling > 0 ? `${nd.rescheduling} rescheduling` : 'Replied NO'; const dateDisplay = nd.date ? formatDate(nd.date) : '‚Äî'; document.getElementById('overview-title').textContent = showAllTime ? 'All-Time Stats' : `Deliveries ‚Äî ${dateDisplay}`; const today = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }); document.getElementById('overview-subtitle').textContent = `${today} ‚Äî ${nd.total || 0} stops on the route`; } const totalPending = nd.pending || 0; if (totalPending > 0) { document.getElementById('send-all-btn').style.display = ''; document.getElementById('pending-badge').textContent = totalPending; } else { document.getElementById('send-all-btn').style.display = 'none'; } const tm = data.tomorrow || {}; document.getElementById('tomorrow-date').textContent = formatDate(tm.date); document.getElementById('tomorrow-total').textContent = tm.total || 0; document.getElementById('tomorrow-pending').textContent = tm.pending || 0; document.getElementById('tomorrow-sent').textContent = tm.sent || 0; const sched = data.scheduler || {}; document.getElementById('sched-status').textContent = sched.todayIsSendDay ? 'Active ‚Äî Send Day' : 'Paused ‚Äî Weekend'; document.getElementById('sched-status').style.color = sched.todayIsSendDay ? '#2dd4bf' : '#fbbf24'; document.getElementById('sched-next').textContent = sched.nextSendDay ? `${sched.nextSendDay} 6:00 PM` : '‚Äî'; document.getElementById('sched-today').textContent = sched.todayName || '‚Äî'; } catch (e) { console.error('Failed to load stats:', e); } }
    async function loadActivity() { try { const res = await authFetch(API + '/api/activity?limit=20&hours=24'); const logs = await res.json(); const container = document.getElementById('activity-log'); if (logs.length === 0) { container.innerHTML = '<div class="empty">No activity in the last 24 hours</div>'; return; } container.innerHTML = logs.map(log => { const dotColor = log.type.includes('sent') ? '#2dd4bf' : log.type.includes('fail') ? '#ef4444' : log.type.includes('confirm') ? '#818cf8' : log.type.includes('decline') ? '#fbbf24' : log.type.includes('import') ? '#818cf8' : log.type.includes('scheduler') ? '#2dd4bf' : '#475569'; const time = new Date(log.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }); return `<div class="log-entry"><div class="log-dot" style="background:${dotColor}"></div><div style="flex:1"><div style="display:flex;justify-content:space-between;align-items:center"><span class="log-event">${log.type.replace(/_/g, ' ')}</span><span class="log-time">${time}</span></div><div class="log-detail">${log.detail}</div></div></div>`; }).join(''); } catch (e) { console.error('Failed to load activity:', e); } }
    async function triggerManualSend() { try { const res = await authFetch(API + '/api/scheduler/send-now', { method: 'POST' }); const data = await res.json(); showToast(`Manual send: ${data.sent || 0} sent, ${data.failed || 0} failed`); loadStats(); loadActivity(); } catch (e) { showToast('Failed to trigger send'); } }
    async function triggerStaffSummary() { try { const res = await authFetch(API + '/api/scheduler/summary-now', { method: 'POST' }); const data = await res.json(); showToast('Staff summary sent'); loadActivity(); } catch (e) { showToast('Failed to send summary'); } }
    async function triggerSync() { const btn = document.getElementById('sync-btn'); btn.textContent = '‚è≥ Syncing...'; btn.disabled = true; try { const res = await authFetch(API + '/api/sync', { method: 'POST' }); const data = await res.json(); const parts = []; if (data.newStops) parts.push(`${data.newStops} new`); if (data.updated) parts.push(`${data.updated} updated`); if (data.removed) parts.push(`${data.removed} removed`); showToast('Sync complete' + (parts.length ? ' ‚Äî ' + parts.join(', ') : ' ‚Äî no changes')); loadStats(); loadActivity(); loadNotifications(); } catch (e) { showToast('Sync failed'); } finally { btn.textContent = 'üîÑ Sync Routes'; btn.disabled = false; } }
    async function deleteNotification(id) { if (!confirm('Delete this notification?')) return; try { await authFetch(API + '/api/notifications/' + id, { method: 'DELETE' }); showToast('Notification deleted'); loadStats(); loadNotifications(); loadActivity(); } catch (e) { showToast('Failed to delete'); } }
    async function viewConversation(notifId) { try { const res = await authFetch(API + '/api/conversations/' + notifId); const messages = await res.json(); if (messages.length === 0) { alert('No conversation messages yet.'); return; } const text = messages.map(m => { const time = new Date(m.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }); const who = m.role === 'customer' ? 'üë§ Customer' : 'ü§ñ System'; return `${who} (${time}):\n${m.content}`; }).join('\n\n'); alert(text); } catch (e) { showToast('Failed to load conversation'); } }
    async function registerPlanFromUI() { const planInput = document.getElementById('plan-id-input'); const dateInput = document.getElementById('plan-date-input'); const planId = planInput.value.trim(); const date = dateInput.value; if (!planId || !date) { showToast('Enter plan ID and date'); return; } try { const res = await authFetch(API + '/api/plans', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ planId, deliveryDate: date }) }); const data = await res.json(); if (data.success) { showToast('Plan registered ‚Äî hit Sync Routes to import'); planInput.value = ''; loadTrackedPlans(); } else { showToast(data.error || 'Failed'); } } catch (e) { showToast('Failed to register plan'); } }
    async function loadTrackedPlans() { try { const res = await authFetch(API + '/api/plans'); const plans = await res.json(); const container = document.getElementById('tracked-plans-list'); if (!container) return; if (plans.length === 0) { container.innerHTML = '<div style="color:#475569;font-size:12px">No tracked plans. Plans are auto-tracked from webhooks.</div>'; return; } container.innerHTML = plans.map(p => `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #1e293b22;font-size:12px"><span class="mono" style="color:#94a3b8">${p.plan_id}</span><span style="color:#64748b">${p.delivery_date || '‚Äî'}</span></div>`).join(''); } catch (e) {} }
    async function loadNotifications() { const store = document.getElementById('filter-store').value; const status = document.getElementById('filter-status').value; let url = API + '/api/notifications?limit=50'; if (store) url += '&store=' + store; if (status) url += '&status=' + status; try { const res = await authFetch(url); const data = await res.json(); const tbody = document.getElementById('notifications-table'); if (data.notifications.length === 0) { tbody.innerHTML = '<tr><td colspan="9" class="empty">No notifications match your filters</td></tr>'; return; } tbody.innerHTML = data.notifications.map(n => { const responseDisplay = n.customer_response === 'yes' ? '<span style="color:#2dd4bf;font-weight:600">‚úì YES</span>' : n.customer_response === 'no' ? '<span style="color:#ef4444;font-weight:600">‚úó NO</span>' : n.customer_response === 'stop' ? '<span style="color:#64748b;font-weight:600">STOP</span>' : '<span style="color:#475569">‚Äî</span>'; const reviewDisplay = n.review_sent_at ? '<span style="color:#fbbf24;font-weight:600">‚≠ê Sent</span>' : n.store === 'other' ? '<span style="color:#475569">N/A</span>' : '<span style="color:#475569">‚Äî</span>'; const convoDisplay = n.conversation_state === 'rescheduling' ? `<span style="color:#fbbf24;font-size:11px;cursor:pointer" onclick="viewConversation(${n.id})">üîÑ Rescheduling</span>` : ''; return `<tr${n.status === 'cancelled' ? ' style="opacity:0.5"' : ''}><td><div style="font-weight:600">${n.customer_name}</div><div class="mono" style="font-size:11px;color:#64748b">${n.phone}</div>${convoDisplay}</td><td>${storeDot(n.store)}</td><td style="color:#94a3b8">${n.scheduled_date || '‚Äî'}</td><td style="color:#94a3b8">${n.time_window || '‚Äî'}</td><td style="color:#94a3b8;font-size:12px">${n.product || '‚Äî'}</td><td>${badge(n.status)}</td><td>${responseDisplay}</td><td>${reviewDisplay}</td><td>${n.status === 'failed' ? `<button class="btn btn-danger" onclick="retrySend(${n.id})">Retry</button>` : ''}${n.status === 'pending' ? `<button class="btn btn-outline" onclick="sendOne(${n.id})">Send</button>` : ''}<button class="btn btn-danger" onclick="deleteNotification(${n.id})" style="padding:5px 8px" title="Delete">‚úï</button></td></tr>`}).join(''); } catch (e) { console.error('Failed to load notifications:', e); } }
    async function sendOne(id) { try { await authFetch(API + '/api/notifications/' + id + '/send', { method: 'POST' }); showToast('SMS sent successfully'); loadNotifications(); loadStats(); loadActivity(); } catch (e) { showToast('Failed to send'); } }
    async function retrySend(id) { await sendOne(id); }
    async function sendAllPending() { try { const res = await authFetch(API + '/api/notifications/actions/send-all-pending', { method: 'POST' }); const data = await res.json(); showToast(`Sent: ${data.sent}, Failed: ${data.failed}`); loadStats(); loadActivity(); } catch (e) { showToast('Failed to send all'); } }
    async function loadSettings() { try { const [connRes, tmplRes] = await Promise.all([authFetch(API + '/api/connections'), authFetch(API + '/api/template')]); const conn = await connRes.json(); const tmpl = await tmplRes.json(); document.getElementById('webhook-url').value = conn.spoke.webhookUrl || '‚Äî'; document.getElementById('spoke-config-status').textContent = conn.spoke.configured ? '‚úì Configured' : '‚úó Missing API Key'; document.getElementById('spoke-config-status').style.color = conn.spoke.configured ? '#2dd4bf' : '#ef4444'; document.getElementById('quo-config-status').textContent = conn.quo.configured ? (conn.quo.live ? '‚úì Live' : '‚ö† Configured (unreachable)') : '‚úó Missing API Key'; document.getElementById('quo-config-status').style.color = conn.quo.configured ? (conn.quo.live ? '#2dd4bf' : '#fbbf24') : '#ef4444'; document.getElementById('template-display').textContent = tmpl.body || 'No template set'; document.getElementById('template-input').value = tmpl.body || ''; loadTrackedPlans(); } catch (e) { console.error('Failed to load settings:', e); } }
    function toggleTemplateEdit() { const editor = document.getElementById('template-editor'); editor.style.display = editor.style.display === 'none' ? '' : 'none'; }
    async function saveTemplate() { const body = document.getElementById('template-input').value; try { await authFetch(API + '/api/template', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ body }) }); document.getElementById('template-display').textContent = body; document.getElementById('template-editor').style.display = 'none'; showToast('Template saved'); } catch (e) { showToast('Failed to save template'); } }
    async function checkConnections() { try { const res = await authFetch(API + '/api/connections'); const conn = await res.json(); const spokeDot = document.getElementById('spoke-dot'); const spokeStatus = document.getElementById('spoke-status'); spokeDot.className = 'conn-dot ' + (conn.spoke.configured ? 'live' : 'down'); spokeStatus.className = 'conn-status ' + (conn.spoke.configured ? 'live' : 'down'); spokeStatus.textContent = conn.spoke.configured ? 'Live' : 'Down'; const quoDot = document.getElementById('quo-dot'); const quoStatus = document.getElementById('quo-status'); const quoOk = conn.quo.configured && conn.quo.live; quoDot.className = 'conn-dot ' + (quoOk ? 'live' : 'down'); quoStatus.className = 'conn-status ' + (quoOk ? 'live' : 'down'); quoStatus.textContent = quoOk ? 'Live' : (conn.quo.configured ? 'Error' : 'Down'); } catch (e) { console.error('Connection check failed:', e); } }
    Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = '#1e293b22'; Chart.defaults.font.family = "'DM Sans', sans-serif"; Chart.defaults.responsive = true; Chart.defaults.maintainAspectRatio = false; Chart.defaults.animation = { duration: 400 };
    let dailyChart, responsesChart, storesChart, windowsChart;
    function destroyCharts() { if (dailyChart) { dailyChart.destroy(); dailyChart = null; } if (responsesChart) { responsesChart.destroy(); responsesChart = null; } if (storesChart) { storesChart.destroy(); storesChart = null; } if (windowsChart) { windowsChart.destroy(); windowsChart = null; } }
    async function loadCharts() { const reportsTab = document.getElementById('tab-reports'); if (reportsTab.style.display === 'none') return; const days = document.getElementById('chart-days').value; try { const [dailyRes, responseRes, storeRes, windowRes] = await Promise.all([authFetch(API + '/api/charts/daily?days=' + days), authFetch(API + '/api/charts/responses'), authFetch(API + '/api/charts/stores'), authFetch(API + '/api/charts/time-windows')]); const daily = await dailyRes.json(); const responses = await responseRes.json(); const stores = await storeRes.json(); const windows = await windowRes.json(); const confirmRate = responses.total > 0 ? Math.round((responses.yes / responses.total) * 100) : 0; const declineRate = responses.total > 0 ? Math.round((responses.no / responses.total) * 100) : 0; const noReplyRate = responses.total > 0 ? Math.round((responses.noReply / responses.total) * 100) : 0; document.getElementById('kpi-confirm-rate').textContent = confirmRate + '%'; document.getElementById('kpi-confirm-sub').textContent = `${responses.yes} of ${responses.total} sent`; document.getElementById('kpi-decline-rate').textContent = declineRate + '%'; document.getElementById('kpi-decline-sub').textContent = `${responses.no} need rescheduling`; document.getElementById('kpi-reviews').textContent = responses.reviewsSent; document.getElementById('kpi-reviews-sub').textContent = 'Google review requests'; document.getElementById('kpi-noreply').textContent = noReplyRate + '%'; document.getElementById('kpi-noreply-sub').textContent = `${responses.noReply} no response`; destroyCharts(); const dailyLabels = daily.map(d => { const dt = new Date(d.date + 'T12:00:00'); return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }); const dailyCtx = document.getElementById('chart-daily').getContext('2d'); dailyChart = new Chart(dailyCtx, { type: 'bar', data: { labels: dailyLabels, datasets: [{ label: 'Confirmed', data: daily.map(d => d.confirmed), backgroundColor: '#2dd4bf', borderRadius: 4, borderSkipped: false }, { label: 'Declined', data: daily.map(d => d.declined), backgroundColor: '#ef4444', borderRadius: 4, borderSkipped: false }, { label: 'No Reply', data: daily.map(d => d.total - d.confirmed - d.declined), backgroundColor: '#334155', borderRadius: 4, borderSkipped: false }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 16, font: { size: 11 } } } }, scales: { x: { stacked: true, grid: { display: false }, ticks: { font: { size: 11 } } }, y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } }, grid: { color: '#1e293b44' } } } } }); const respCtx = document.getElementById('chart-responses').getContext('2d'); responsesChart = new Chart(respCtx, { type: 'doughnut', data: { labels: ['Confirmed (YES)', 'Declined (NO)', 'Opted Out (STOP)', 'No Reply'], datasets: [{ data: [responses.yes, responses.no, responses.stop, responses.noReply], backgroundColor: ['#2dd4bf', '#ef4444', '#64748b', '#334155'], borderWidth: 0, hoverOffset: 6 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '62%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 14, font: { size: 11 } } }, tooltip: { callbacks: { label: function(ctx) { const total = ctx.dataset.data.reduce((a, b) => a + b, 0); const pct = total > 0 ? Math.round((ctx.raw / total) * 100) : 0; return `${ctx.label}: ${ctx.raw} (${pct}%)`; } } } } } }); const storeLabelsArr = stores.map(s => storeNames[s.store] || s.store); const storesCtx = document.getElementById('chart-stores').getContext('2d'); storesChart = new Chart(storesCtx, { type: 'bar', data: { labels: storeLabelsArr, datasets: [{ label: 'Confirmed', data: stores.map(s => s.confirmed), backgroundColor: '#2dd4bf', borderRadius: 4 }, { label: 'Declined', data: stores.map(s => s.declined), backgroundColor: '#ef4444', borderRadius: 4 }, { label: 'Other', data: stores.map(s => s.total - s.confirmed - s.declined), backgroundColor: '#334155', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 16, font: { size: 11 } } } }, scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: '#1e293b44' } } } } }); const windowLabels = windows.map(w => w.time_window); const windowCtx = document.getElementById('chart-windows').getContext('2d'); windowsChart = new Chart(windowCtx, { type: 'bar', data: { labels: windowLabels, datasets: [{ label: 'Deliveries', data: windows.map(w => w.count), backgroundColor: '#818cf8', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: '#1e293b44' } }, y: { grid: { display: false }, ticks: { font: { size: 11 } } } } } }); const perfTable = document.getElementById('store-perf-table'); if (stores.length === 0) { perfTable.innerHTML = '<tr><td colspan="6" class="empty">No store data yet</td></tr>'; } else { perfTable.innerHTML = stores.map(s => { const confirmPct = s.total > 0 ? Math.round((s.confirmed / s.total) * 100) : 0; return `<tr><td>${storeDot(s.store)}</td><td style="font-weight:600">${s.total}</td><td style="color:#2dd4bf;font-weight:600">${s.confirmed}</td><td style="color:#ef4444;font-weight:600">${s.declined}</td><td><div style="display:flex;align-items:center;gap:8px"><div style="width:60px;height:6px;background:#1e293b;border-radius:3px;overflow:hidden"><div style="width:${confirmPct}%;height:100%;background:${confirmPct >= 70 ? '#2dd4bf' : confirmPct >= 40 ? '#fbbf24' : '#ef4444'};border-radius:3px"></div></div><span style="font-size:12px;font-weight:600;font-family:'JetBrains Mono',monospace">${confirmPct}%</span></div></td><td style="color:#fbbf24;font-weight:600">${s.reviews_sent}</td></tr>`; }).join(''); } } catch (e) { console.error('Failed to load charts:', e); } }
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Sale Reviews Functions
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let reviewComparisonChart = null;
    async function submitSaleReview() {
      const name = document.getElementById('sr-name').value.trim();
      const phone = document.getElementById('sr-phone').value.trim();
      const sale = document.getElementById('sr-sale').value.trim();
      if (!name || !phone || !sale) { showToast('Please fill in all fields'); return; }
      const btn = document.getElementById('sr-submit-btn');
      btn.textContent = '‚è≥ Generating & Sending...'; btn.disabled = true;
      try {
        const res = await authFetch(API + '/api/reviews/sale', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ customerName: name, phone: phone, saleNumber: sale }) });
        const data = await res.json();
        if (data.success) { showToast(data.message || 'Review request sent!'); document.getElementById('sr-name').value = ''; document.getElementById('sr-phone').value = ''; document.getElementById('sr-sale').value = ''; loadSaleReviews(); loadReviewComparison(); loadActivity(); }
        else { showToast(data.error || 'Failed to send'); }
      } catch (e) { showToast('Failed to send review request'); console.error('Sale review error:', e); }
      finally { btn.textContent = '‚≠ê Send Review Request'; btn.disabled = false; }
    }
    async function loadSaleReviews() {
      const store = document.getElementById('sr-filter-store').value;
      let url = API + '/api/reviews/sale?limit=50';
      if (store) url += '&store=' + store;
      try {
        const res = await authFetch(url); const data = await res.json(); const tbody = document.getElementById('sr-table');
        if (data.reviews.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="empty">No sale reviews yet. Use the form above to send your first one!</td></tr>'; return; }
        tbody.innerHTML = data.reviews.map(r => {
          const statusBadge = r.status === 'sent' ? '<span class="badge badge-sent">sent</span>' : r.status === 'failed' ? '<span class="badge badge-failed">failed</span>' : '<span class="badge badge-pending">pending</span>';
          const clickedDisplay = r.clicked_at ? `<span style="color:#2dd4bf;font-weight:600">‚úì ${new Date(r.clicked_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>` : '<span style="color:#475569">‚Äî</span>';
          const sentDisplay = r.sent_at ? new Date(r.sent_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) : '‚Äî';
          const msgPreview = r.ai_message ? r.ai_message.substring(0, 60) + (r.ai_message.length > 60 ? '...' : '') : '‚Äî';
          return `<tr><td><div style="font-weight:600">${r.customer_name}</div><div class="mono" style="font-size:11px;color:#64748b">${r.phone}</div></td><td>${storeDot(r.store)}</td><td class="mono" style="color:#94a3b8">${r.sale_number}</td><td style="color:#94a3b8;font-size:12px;max-width:200px" title="${(r.ai_message || '').replace(/"/g, '&quot;')}">${msgPreview}</td><td>${statusBadge}</td><td>${clickedDisplay}</td><td style="color:#64748b;font-size:12px">${sentDisplay}</td><td><button class="btn btn-danger" onclick="deleteSaleReview(${r.id})" style="padding:5px 8px" title="Delete">‚úï</button></td></tr>`;
        }).join('');
      } catch (e) { console.error('Failed to load sale reviews:', e); }
    }
    async function deleteSaleReview(id) {
      if (!confirm('Delete this sale review record?')) return;
      try { await authFetch(API + '/api/reviews/sale/' + id, { method: 'DELETE' }); showToast('Sale review deleted'); loadSaleReviews(); loadReviewComparison(); } catch (e) { showToast('Failed to delete'); }
    }
    async function loadReviewComparison() {
      try {
        const res = await authFetch(API + '/api/reviews/comparison'); const data = await res.json();
        document.getElementById('sr-sale-total').textContent = data.sale.total;
        document.getElementById('sr-sale-clicked').textContent = data.sale.clicked;
        document.getElementById('sr-sale-rate').textContent = data.sale.clickRate + '%';
        document.getElementById('sr-delivery-total').textContent = data.delivery.total;
        document.getElementById('sr-delivery-clicked').textContent = data.delivery.clicked;
        document.getElementById('sr-delivery-rate').textContent = data.delivery.clickRate + '%';
        if (reviewComparisonChart) { reviewComparisonChart.destroy(); reviewComparisonChart = null; }
        const storeLabelsArr = [...new Set([...data.saleByStore.map(s => s.store), ...data.deliveryByStore.map(s => s.store)])];
        const storeDisplayNames = { somerset: 'Somerset', london: 'London', georgetown: 'Georgetown', lexington: 'Nicholasville Rd' };
        const saleData = storeLabelsArr.map(store => { const row = data.saleByStore.find(s => s.store === store); return row ? (row.total > 0 ? Math.round((row.clicked / row.total) * 100) : 0) : 0; });
        const deliveryData = storeLabelsArr.map(store => { const row = data.deliveryByStore.find(s => s.store === store); return row ? (row.total > 0 ? Math.round((row.review_sent / row.total) * 100) : 0) : 0; });
        const ctx = document.getElementById('chart-review-comparison').getContext('2d');
        reviewComparisonChart = new Chart(ctx, { type: 'bar', data: { labels: storeLabelsArr.map(s => storeDisplayNames[s] || s), datasets: [{ label: 'Day-of-Sale Click Rate %', data: saleData, backgroundColor: '#fbbf24', borderRadius: 4, borderSkipped: false }, { label: 'Delivery-Day Click Rate %', data: deliveryData, backgroundColor: '#818cf8', borderRadius: 4, borderSkipped: false }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 16, font: { size: 11 } } } }, scales: { x: { grid: { display: false }, ticks: { font: { size: 11 } } }, y: { beginAtZero: true, max: 100, ticks: { stepSize: 25, font: { size: 11 }, callback: v => v + '%' }, grid: { color: '#1e293b44' } } } } });
      } catch (e) { console.error('Failed to load review comparison:', e); }
    }
    checkAuth().then(ok => { if (ok) initDashboard(); });
    setInterval(() => { if (document.getElementById('login-overlay').style.display !== 'flex') { loadStats(); loadActivity(); checkConnections(); } }, 30000);
  </script>
</body>
</html>
