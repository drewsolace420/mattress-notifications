<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mattress Overstock ‚Äî Delivery Notifications</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: #080c14; color: #e2e8f0; min-height: 100vh; }
    .mono { font-family: 'JetBrains Mono', monospace; }

    /* Header */
    header { border-bottom: 1px solid #1e293b; padding: 16px 28px; display: flex; align-items: center; justify-content: space-between; background: #0b1120; }
    .logo { display: flex; align-items: center; gap: 14px; }
    .logo-icon { width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg, #2dd4bf, #818cf8); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; color: #080c14; }
    .logo-text h1 { font-size: 16px; font-weight: 700; letter-spacing: -0.3px; }
    .logo-text span { font-size: 11px; color: #64748b; letter-spacing: 0.5px; }
    .connections { display: flex; gap: 12px; }
    .conn-badge { display: flex; align-items: center; gap: 8px; padding: 6px 14px; border-radius: 8px; background: #0f172a; border: 1px solid #1e293b; font-size: 12px; }
    .conn-dot { width: 8px; height: 8px; border-radius: 50%; }
    .conn-dot.live { background: #2dd4bf; animation: pulse 2s infinite; }
    .conn-dot.down { background: #ef4444; }
    .conn-label { color: #94a3b8; font-weight: 500; }
    .conn-status { font-weight: 600; font-size: 11px; text-transform: uppercase; }
    .conn-status.live { color: #2dd4bf; }
    .conn-status.down { color: #ef4444; }

    @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(45,212,191,0.4); } 50% { box-shadow: 0 0 0 6px rgba(45,212,191,0); } }

    /* Nav */
    nav { border-bottom: 1px solid #1e293b; padding: 0 28px; background: #0b1120; display: flex; }
    nav button { padding: 14px 22px; font-size: 13px; font-weight: 600; color: #64748b; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; letter-spacing: 0.2px; transition: all 0.2s; font-family: inherit; }
    nav button.active { color: #2dd4bf; border-bottom-color: #2dd4bf; }
    nav button:hover { color: #94a3b8; }

    /* Main */
    main { padding: 24px 28px; max-width: 1200px; margin: 0 auto; }

    /* Stat Cards */
    .stats { display: flex; gap: 14px; margin-bottom: 28px; flex-wrap: wrap; }
    .stat-card { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 20px 22px; flex: 1; min-width: 140px; }
    .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px; color: #64748b; margin-bottom: 8px; font-weight: 600; }
    .stat-value { font-size: 32px; font-weight: 700; line-height: 1; font-family: 'JetBrains Mono', monospace; }
    .stat-sub { font-size: 11px; color: #475569; margin-top: 6px; }

    /* Panel */
    .panel { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 18px; }
    .panel h3 { font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin-bottom: 14px; }

    /* Table */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: #64748b; border-bottom: 1px solid #1e293b; }
    td { padding: 14px 16px; border-bottom: 1px solid #1e293b22; }
    tr:hover { background: #1e293b33; }

    /* Badge */
    .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; }
    .badge-sent { color: #2dd4bf; background: rgba(45,212,191,0.12); border: 1px solid rgba(45,212,191,0.13); }
    .badge-pending { color: #fbbf24; background: rgba(251,191,36,0.12); border: 1px solid rgba(251,191,36,0.13); }
    .badge-failed { color: #ef4444; background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.13); }
    .badge-delivered { color: #818cf8; background: rgba(129,140,248,0.12); border: 1px solid rgba(129,140,248,0.13); }

    /* Store dot */
    .store-dot { display: inline-flex; align-items: center; gap: 5px; font-size: 12px; color: #94a3b8; }
    .store-dot span { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

    /* Buttons */
    .btn { padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: opacity 0.2s; font-family: inherit; }
    .btn:hover { opacity: 0.85; }
    .btn-primary { background: linear-gradient(135deg, #2dd4bf, #14b8a6); color: #042f2e; }
    .btn-outline { background: transparent; border: 1px solid #2dd4bf; color: #2dd4bf; padding: 5px 12px; font-size: 11px; }
    .btn-danger { background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 5px 12px; font-size: 11px; }

    /* Activity log */
    .log-entry { padding: 10px 0; border-bottom: 1px solid #1e293b22; display: flex; gap: 12px; align-items: flex-start; }
    .log-dot { width: 7px; height: 7px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
    .log-event { font-size: 12px; font-weight: 600; color: #cbd5e1; }
    .log-time { font-size: 11px; color: #475569; font-family: 'JetBrains Mono', monospace; }
    .log-detail { font-size: 12px; color: #64748b; margin-top: 2px; }

    /* Grid */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }

    /* Workflow */
    .workflow { display: flex; align-items: center; justify-content: center; gap: 0; flex-wrap: wrap; padding: 10px 0; }
    .workflow-step { text-align: center; padding: 14px 16px; background: #1e293b44; border-radius: 10px; border: 1px solid #1e293b; min-width: 120px; }
    .workflow-step .icon { font-size: 24px; margin-bottom: 6px; }
    .workflow-step .label { font-size: 12px; font-weight: 700; color: #e2e8f0; }
    .workflow-step .sub { font-size: 10px; color: #64748b; margin-top: 2px; }
    .workflow-arrow { width: 40px; height: 2px; background: linear-gradient(90deg, #2dd4bf44, #818cf844); margin: 0 -2px; }

    /* Toast */
    .toast { position: fixed; top: 20px; right: 20px; z-index: 999; background: #166534; color: #bbf7d0; padding: 12px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; box-shadow: 0 8px 30px rgba(0,0,0,0.4); transform: translateX(120%); transition: transform 0.3s ease; }
    .toast.show { transform: translateX(0); }

    /* Filters */
    select { padding: 8px 12px; border-radius: 8px; border: 1px solid #1e293b; background: #0f172a; color: #e2e8f0; font-size: 12px; font-weight: 500; cursor: pointer; font-family: inherit; }
    select:focus { outline: none; border-color: #2dd4bf; }

    /* Empty state */
    .empty { padding: 40px; text-align: center; color: #475569; }

    /* Loading */
    .loading { text-align: center; padding: 40px; color: #64748b; }

    /* Responsive */
    @media (max-width: 768px) {
      .grid-2 { grid-template-columns: 1fr; }
      .stats { flex-direction: column; }
      .workflow { flex-direction: column; }
      .workflow-arrow { width: 2px; height: 20px; }
    }
  </style>
</head>
<body>
  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Header -->
  <header>
    <div class="logo">
      <div class="logo-icon">M</div>
      <div class="logo-text">
        <h1>Mattress Overstock</h1>
        <span>DELIVERY NOTIFICATION HUB</span>
      </div>
    </div>
    <div class="connections">
      <div class="conn-badge">
        <div id="spoke-dot" class="conn-dot live"></div>
        <span class="conn-label">Spoke Dispatch</span>
        <span id="spoke-status" class="conn-status live">Live</span>
      </div>
      <div class="conn-badge">
        <div id="quo-dot" class="conn-dot live"></div>
        <span class="conn-label">Quo</span>
        <span id="quo-status" class="conn-status live">Live</span>
      </div>
    </div>
  </header>

  <!-- Nav -->
  <nav>
    <button class="active" data-tab="overview">Overview</button>
    <button data-tab="notifications">Notifications</button>
    <button data-tab="reports">Reports</button>
    <button data-tab="settings">Settings</button>
  </nav>

  <!-- Main Content -->
  <main>
    <!-- Overview Tab -->
    <div id="tab-overview">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <div>
          <h2 style="font-size:22px;font-weight:700;letter-spacing:-0.5px" id="overview-title">Today's Deliveries</h2>
          <p style="color:#64748b;font-size:13px;margin-top:4px" id="overview-subtitle">Loading...</p>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="btn btn-outline" id="toggle-view-btn" onclick="toggleStatsView()" style="font-size:11px">Show All-Time</button>
          <button class="btn btn-primary" id="send-all-btn" style="display:none" onclick="sendAllPending()">
            Send All Pending (<span id="pending-badge">0</span>)
          </button>
        </div>
      </div>

      <div class="stats" id="stats-container">
        <div class="stat-card"><div class="stat-label">Sent</div><div class="stat-value" id="stat-sent" style="color:#2dd4bf">‚Äî</div><div class="stat-sub" id="sub-sent">SMS delivered today</div></div>
        <div class="stat-card"><div class="stat-label">Pending</div><div class="stat-value" id="stat-pending" style="color:#fbbf24">‚Äî</div><div class="stat-sub" id="sub-pending">Awaiting 6 PM send</div></div>
        <div class="stat-card"><div class="stat-label">Failed</div><div class="stat-value" id="stat-failed" style="color:#ef4444">‚Äî</div><div class="stat-sub" id="sub-failed">Needs attention</div></div>
        <div class="stat-card"><div class="stat-label">Confirmed</div><div class="stat-value" id="stat-delivered" style="color:#818cf8">‚Äî</div><div class="stat-sub" id="sub-delivered">Replied YES</div></div>
      </div>

      <!-- Tomorrow's Queue + Scheduler -->
      <div class="grid-2" style="margin-bottom:18px">
        <div class="panel" style="border-left:3px solid #818cf8">
          <h3 style="display:flex;justify-content:space-between;align-items:center">
            <span>Tomorrow's Queue</span>
            <span class="mono" id="tomorrow-date" style="font-size:11px;color:#64748b;text-transform:none;letter-spacing:0">‚Äî</span>
          </h3>
          <div style="display:flex;gap:20px;margin-top:12px">
            <div>
              <div style="font-size:28px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#818cf8" id="tomorrow-total">0</div>
              <div style="font-size:11px;color:#64748b;margin-top:2px">Total stops</div>
            </div>
            <div>
              <div style="font-size:28px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#fbbf24" id="tomorrow-pending">0</div>
              <div style="font-size:11px;color:#64748b;margin-top:2px">Pending send</div>
            </div>
            <div>
              <div style="font-size:28px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#2dd4bf" id="tomorrow-sent">0</div>
              <div style="font-size:11px;color:#64748b;margin-top:2px">Already sent</div>
            </div>
          </div>
        </div>
        <div class="panel" style="border-left:3px solid #2dd4bf">
          <h3>Scheduler</h3>
          <div style="margin-top:10px;font-size:13px;line-height:2">
            <div style="display:flex;justify-content:space-between">
              <span style="color:#64748b">Status</span>
              <span id="sched-status" style="font-weight:600;color:#2dd4bf">Active</span>
            </div>
            <div style="display:flex;justify-content:space-between">
              <span style="color:#64748b">Customer SMS</span>
              <span class="mono" id="sched-next" style="font-size:12px;color:#e2e8f0">‚Äî</span>
            </div>
            <div style="display:flex;justify-content:space-between">
              <span style="color:#64748b">Staff summary</span>
              <span class="mono" id="sched-summary" style="font-size:12px;color:#e2e8f0">9:00 PM EST</span>
            </div>
            <div style="display:flex;justify-content:space-between">
              <span style="color:#64748b">Today</span>
              <span id="sched-today" style="font-size:12px;color:#e2e8f0">‚Äî</span>
            </div>
            <div style="display:flex;gap:8px;margin-top:6px">
              <button class="btn btn-outline" onclick="triggerManualSend()" style="flex:1;text-align:center;font-size:11px">‚ö° Send Now</button>
              <button class="btn btn-outline" onclick="triggerStaffSummary()" style="flex:1;text-align:center;font-size:11px">üìã Summary Now</button>
            </div>
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div class="panel">
          <h3 style="display:flex;justify-content:space-between;align-items:center">
            <span>Recent Activity</span>
            <span style="font-size:10px;color:#475569;text-transform:none;letter-spacing:0;font-weight:400">Last 24 hours</span>
          </h3>
          <div id="activity-log">
            <div class="loading">Loading activity...</div>
          </div>
        </div>
        <div class="panel">
          <h3>Automation Workflow</h3>
          <div class="workflow">
            <div class="workflow-step"><div class="icon">üì¶</div><div class="label">Spoke Dispatch</div><div class="sub">Route sent to driver</div></div>
            <div class="workflow-arrow"></div>
            <div class="workflow-step"><div class="icon">‚öôÔ∏è</div><div class="label">Process Stop</div><div class="sub">Fetch recipient + ETA</div></div>
            <div class="workflow-arrow"></div>
            <div class="workflow-step"><div class="icon">‚è∞</div><div class="label">6 PM EST</div><div class="sub">Daily batch send</div></div>
            <div class="workflow-arrow"></div>
            <div class="workflow-step"><div class="icon">üí¨</div><div class="label">SMS via Quo</div><div class="sub">YES / NO reply</div></div>
          </div>
          <div style="margin-top:14px;padding:12px;background:#1e293b44;border-radius:8px;font-size:11px;color:#64748b;line-height:1.8">
            <strong style="color:#94a3b8">6 PM:</strong> Customer texts sent Mon‚ÄìFri for next-day deliveries<br>
            <strong style="color:#94a3b8">9 PM:</strong> Staff summary sent to scheduling team<br>
            <strong style="color:#94a3b8">Windows:</strong> 2-hour blocks, rounded up to nearest :30<br>
            <strong style="color:#94a3b8">Replies:</strong> YES = confirmed, NO = needs rescheduling
          </div>
        </div>
      </div>
    </div>

    <!-- Notifications Tab -->
    <div id="tab-notifications" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
        <h2 style="font-size:20px;font-weight:700">All Notifications</h2>
        <div style="display:flex;gap:10px">
          <select id="filter-store" onchange="loadNotifications()">
            <option value="">All Stores</option>
            <option value="somerset">Somerset</option>
            <option value="lexington">Nicholasville Rd</option>
            <option value="london">London</option>
            <option value="georgetown">Georgetown</option>
            <option value="richmond">Richmond</option>
            <option value="winchester">Winchester</option>
            <option value="laurel">Laurel County</option>
          </select>
          <select id="filter-status" onchange="loadNotifications()">
            <option value="">All Status</option>
            <option value="sent">Sent</option>
            <option value="pending">Pending</option>
            <option value="failed">Failed</option>
            <option value="delivered">Delivered</option>
          </select>
        </div>
      </div>
      <div class="panel">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Customer</th>
                <th>Store</th>
                <th>Delivery Date</th>
                <th>Time Window</th>
                <th>Product</th>
                <th>Status</th>
                <th>Response</th>
                <th>Review</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="notifications-table">
              <tr><td colspan="9" class="loading">Loading notifications...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="tab-settings" style="display:none">

    <!-- Reports Tab -->
    <div id="tab-reports" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <div>
          <h2 style="font-size:22px;font-weight:700;letter-spacing:-0.5px">Reports & Analytics</h2>
          <p style="color:#64748b;font-size:13px;margin-top:4px">Performance metrics across all stores</p>
        </div>
        <select id="chart-days" onchange="loadCharts()" style="padding:8px 14px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#94a3b8;font-size:13px;font-family:inherit;cursor:pointer">
          <option value="7">Last 7 days</option>
          <option value="14" selected>Last 14 days</option>
          <option value="30">Last 30 days</option>
        </select>
      </div>

      <!-- KPI Row -->
      <div class="stats" id="report-kpis">
        <div class="stat-card">
          <div class="stat-label">Confirmation Rate</div>
          <div class="stat-value" id="kpi-confirm-rate" style="color:#2dd4bf">‚Äî</div>
          <div class="stat-sub" id="kpi-confirm-sub">of sent messages</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Decline Rate</div>
          <div class="stat-value" id="kpi-decline-rate" style="color:#ef4444">‚Äî</div>
          <div class="stat-sub" id="kpi-decline-sub">need rescheduling</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Reviews Sent</div>
          <div class="stat-value" id="kpi-reviews" style="color:#fbbf24">‚Äî</div>
          <div class="stat-sub" id="kpi-reviews-sub">Google review requests</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">No Reply</div>
          <div class="stat-value" id="kpi-noreply" style="color:#64748b">‚Äî</div>
          <div class="stat-sub" id="kpi-noreply-sub">no response yet</div>
        </div>
      </div>

      <!-- Charts Row 1: Volume + Response Donut -->
      <div class="grid-2">
        <div class="panel" style="min-height:320px">
          <h3>Daily Volume</h3>
          <canvas id="chart-daily" height="260"></canvas>
        </div>
        <div class="panel" style="min-height:320px">
          <h3>Customer Responses</h3>
          <canvas id="chart-responses" height="260"></canvas>
        </div>
      </div>

      <!-- Charts Row 2: Store Breakdown + Time Window -->
      <div class="grid-2">
        <div class="panel" style="min-height:320px">
          <h3>Deliveries by Store</h3>
          <canvas id="chart-stores" height="260"></canvas>
        </div>
        <div class="panel" style="min-height:320px">
          <h3>Delivery Time Windows</h3>
          <canvas id="chart-windows" height="260"></canvas>
        </div>
      </div>

      <!-- Store Performance Table -->
      <div class="panel">
        <h3>Store Performance</h3>
        <table>
          <thead>
            <tr>
              <th>Store</th>
              <th>Deliveries</th>
              <th>Confirmed</th>
              <th>Declined</th>
              <th>Confirm %</th>
              <th>Reviews Sent</th>
            </tr>
          </thead>
          <tbody id="store-perf-table">
            <tr><td colspan="6" class="loading">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
      <h2 style="font-size:20px;font-weight:700;margin-bottom:20px">Configuration</h2>

      <div class="panel">
        <h3>API Connections</h3>
        <div class="grid-2">
          <div style="padding:16px;border-radius:10px;border:1px solid #1e293b;background:#1e293b22">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <strong style="font-size:14px">Spoke Dispatch</strong>
              <span id="spoke-config-status" style="font-size:11px;font-weight:600">Checking...</span>
            </div>
            <div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:4px">Webhook URL</div>
            <input readonly id="webhook-url" style="width:100%;padding:10px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#64748b;font-size:12px;font-family:'JetBrains Mono',monospace" value="Loading...">
            <div style="font-size:11px;color:#475569;margin-top:8px">Copy this URL into Spoke Dispatch ‚Üí Settings ‚Üí Integrations ‚Üí Webhooks</div>
          </div>
          <div style="padding:16px;border-radius:10px;border:1px solid #1e293b;background:#1e293b22">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <strong style="font-size:14px">Quo (SMS)</strong>
              <span id="quo-config-status" style="font-size:11px;font-weight:600">Checking...</span>
            </div>
            <div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:4px">API Endpoint</div>
            <input readonly value="https://api.quo.com/v1/messages" style="width:100%;padding:10px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#64748b;font-size:12px;font-family:'JetBrains Mono',monospace">
            <div style="font-size:11px;color:#475569;margin-top:8px">Set QUO_API_KEY and QUO_PHONE_NUMBER_ID in Railway environment variables</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <h3 style="margin-bottom:0">SMS Template</h3>
          <button class="btn btn-outline" onclick="toggleTemplateEdit()">Edit Template</button>
        </div>
        <div id="template-display" style="padding:16px;background:#1e293b44;border-radius:8px;border:1px solid #1e293b;font-size:13px;color:#94a3b8;line-height:1.7">Loading...</div>
        <div id="template-editor" style="display:none;margin-top:12px">
          <textarea id="template-input" rows="4" style="width:100%;padding:10px 14px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#e2e8f0;font-size:13px;font-family:'DM Sans',system-ui;resize:vertical;line-height:1.7"></textarea>
          <div style="font-size:11px;color:#475569;line-height:1.6;margin-top:6px">
            <strong style="color:#64748b">Variables:</strong> {{customer_first}}, {{customer_last}}, {{date}}, {{time_window}}, {{driver}}, {{store}}, {{product}}, {{address}}, {{business_name}}
          </div>
          <button class="btn btn-primary" style="margin-top:12px" onclick="saveTemplate()">Save Template</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API = '';  // Same origin
    let showAllTime = false;

    // ‚îÄ‚îÄ‚îÄ Tab Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.querySelectorAll('nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('main > div[id^="tab-"]').forEach(t => t.style.display = 'none');
        document.getElementById('tab-' + btn.dataset.tab).style.display = '';
        if (btn.dataset.tab === 'notifications') loadNotifications();
        if (btn.dataset.tab === 'reports') loadCharts();
        if (btn.dataset.tab === 'settings') loadSettings();
      });
    });

    // ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = '‚úì ' + msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    // ‚îÄ‚îÄ‚îÄ Store colors ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const storeColors = { richmond: '#2dd4bf', somerset: '#818cf8', laurel: '#fb923c', london: '#f472b6', winchester: '#a3e635', georgetown: '#38bdf8', lexington: '#c084fc' };
    const storeNames = { richmond: 'Richmond', somerset: 'Somerset', laurel: 'Laurel County', london: 'London', winchester: 'Winchester', georgetown: 'Georgetown', lexington: 'Nicholasville Rd' };

    function storeDot(store) {
      const c = storeColors[store] || '#64748b';
      const n = storeNames[store] || store || '‚Äî';
      return `<span class="store-dot"><span style="background:${c}"></span>${n}</span>`;
    }

    function badge(status) {
      return `<span class="badge badge-${status}">${status}</span>`;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '‚Äî';
      const d = new Date(dateStr + 'T12:00:00');
      return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    // ‚îÄ‚îÄ‚îÄ Toggle daily / all-time ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleStatsView() {
      showAllTime = !showAllTime;
      document.getElementById('toggle-view-btn').textContent = showAllTime ? 'Show Today' : 'Show All-Time';
      document.getElementById('overview-title').textContent = showAllTime ? 'All-Time Stats' : "Today's Deliveries";
      loadStats();
    }

    // ‚îÄ‚îÄ‚îÄ Load Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadStats() {
      try {
        const res = await fetch(API + '/api/stats');
        const data = await res.json();

        // Pick daily or all-time
        const s = showAllTime ? data.allTime : data.today;

        document.getElementById('stat-sent').textContent = s.sent || 0;
        document.getElementById('stat-pending').textContent = s.pending || 0;
        document.getElementById('stat-failed').textContent = s.failed || 0;
        document.getElementById('stat-delivered').textContent = s.delivered || 0;

        // Subtitles
        if (showAllTime) {
          document.getElementById('sub-sent').textContent = 'Total SMS sent';
          document.getElementById('sub-pending').textContent = 'Awaiting send';
          document.getElementById('sub-failed').textContent = 'Needs attention';
          document.getElementById('sub-delivered').textContent = 'Confirmed deliveries';
        } else {
          document.getElementById('sub-sent').textContent = 'SMS sent for today';
          document.getElementById('sub-pending').textContent = 'Awaiting 6 PM send';
          document.getElementById('sub-failed').textContent = 'Needs attention';
          document.getElementById('sub-delivered').textContent = 'Replied YES';
        }

        // Show send button if any pending
        const totalPending = data.today.pending + (data.tomorrow?.pending || 0);
        if (totalPending > 0) {
          document.getElementById('send-all-btn').style.display = '';
          document.getElementById('pending-badge').textContent = totalPending;
        } else {
          document.getElementById('send-all-btn').style.display = 'none';
        }

        // Date subtitle
        const today = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('overview-subtitle').textContent = showAllTime
          ? `${data.allTime.total} total notifications processed`
          : `${today} ‚Äî Automated via Spoke Dispatch ‚Üí Quo SMS`;

        // Tomorrow's queue
        const tm = data.tomorrow || {};
        document.getElementById('tomorrow-date').textContent = formatDate(tm.date);
        document.getElementById('tomorrow-total').textContent = tm.total || 0;
        document.getElementById('tomorrow-pending').textContent = tm.pending || 0;
        document.getElementById('tomorrow-sent').textContent = tm.sent || 0;

        // Scheduler
        const sched = data.scheduler || {};
        document.getElementById('sched-status').textContent = sched.todayIsSendDay ? 'Active ‚Äî Send Day' : 'Paused ‚Äî Weekend';
        document.getElementById('sched-status').style.color = sched.todayIsSendDay ? '#2dd4bf' : '#fbbf24';
        document.getElementById('sched-next').textContent = sched.nextSendDay ? `${sched.nextSendDay} 6:00 PM` : '‚Äî';
        document.getElementById('sched-today').textContent = sched.todayName || '‚Äî';

      } catch (e) {
        console.error('Failed to load stats:', e);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Load Activity Log (last 24 hours) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadActivity() {
      try {
        const res = await fetch(API + '/api/activity?limit=20&hours=24');
        const logs = await res.json();
        const container = document.getElementById('activity-log');

        if (logs.length === 0) {
          container.innerHTML = '<div class="empty">No activity in the last 24 hours</div>';
          return;
        }

        container.innerHTML = logs.map(log => {
          const dotColor =
            log.type.includes('sent') ? '#2dd4bf' :
            log.type.includes('fail') ? '#ef4444' :
            log.type.includes('confirm') ? '#818cf8' :
            log.type.includes('decline') ? '#fbbf24' :
            log.type.includes('import') ? '#818cf8' :
            log.type.includes('scheduler') ? '#2dd4bf' :
            '#475569';
          const time = new Date(log.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
          return `<div class="log-entry">
            <div class="log-dot" style="background:${dotColor}"></div>
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <span class="log-event">${log.type.replace(/_/g, ' ')}</span>
                <span class="log-time">${time}</span>
              </div>
              <div class="log-detail">${log.detail}</div>
            </div>
          </div>`;
        }).join('');
      } catch (e) {
        console.error('Failed to load activity:', e);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Manual Send Trigger ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function triggerManualSend() {
      try {
        const res = await fetch(API + '/api/scheduler/send-now', { method: 'POST' });
        const data = await res.json();
        showToast(`Manual send: ${data.sent || 0} sent, ${data.failed || 0} failed`);
        loadStats();
        loadActivity();
      } catch (e) { showToast('Failed to trigger send'); }
    }

    // ‚îÄ‚îÄ‚îÄ Staff Summary Trigger ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function triggerStaffSummary() {
      try {
        const res = await fetch(API + '/api/scheduler/summary-now', { method: 'POST' });
        const data = await res.json();
        showToast('Staff summary sent');
        loadActivity();
      } catch (e) { showToast('Failed to send summary'); }
    }

    // ‚îÄ‚îÄ‚îÄ Load Notifications ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadNotifications() {
      const store = document.getElementById('filter-store').value;
      const status = document.getElementById('filter-status').value;
      let url = API + '/api/notifications?limit=50';
      if (store) url += '&store=' + store;
      if (status) url += '&status=' + status;

      try {
        const res = await fetch(url);
        const data = await res.json();
        const tbody = document.getElementById('notifications-table');

        if (data.notifications.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="empty">No notifications match your filters</td></tr>';
          return;
        }

        tbody.innerHTML = data.notifications.map(n => {
          const responseDisplay = n.customer_response === 'yes' ? '<span style="color:#2dd4bf;font-weight:600">‚úì YES</span>'
            : n.customer_response === 'no' ? '<span style="color:#ef4444;font-weight:600">‚úó NO</span>'
            : n.customer_response === 'stop' ? '<span style="color:#64748b;font-weight:600">STOP</span>'
            : '<span style="color:#475569">‚Äî</span>';
          const reviewDisplay = n.review_sent_at
            ? '<span style="color:#fbbf24;font-weight:600">‚≠ê Sent</span>'
            : n.store === 'other' ? '<span style="color:#475569">N/A</span>'
            : '<span style="color:#475569">‚Äî</span>';
          return `<tr>
          <td>
            <div style="font-weight:600">${n.customer_name}</div>
            <div class="mono" style="font-size:11px;color:#64748b">${n.phone}</div>
          </td>
          <td>${storeDot(n.store)}</td>
          <td style="color:#94a3b8">${n.scheduled_date || '‚Äî'}</td>
          <td style="color:#94a3b8">${n.time_window || '‚Äî'}</td>
          <td style="color:#94a3b8;font-size:12px">${n.product || '‚Äî'}</td>
          <td>${badge(n.status)}</td>
          <td>${responseDisplay}</td>
          <td>${reviewDisplay}</td>
          <td>
            ${n.status === 'failed' ? `<button class="btn btn-danger" onclick="retrySend(${n.id})">Retry</button>` : ''}
            ${n.status === 'pending' ? `<button class="btn btn-outline" onclick="sendOne(${n.id})">Send</button>` : ''}
          </td>
        </tr>`}).join('');
      } catch (e) {
        console.error('Failed to load notifications:', e);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Send Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function sendOne(id) {
      try {
        await fetch(API + '/api/notifications/' + id + '/send', { method: 'POST' });
        showToast('SMS sent successfully');
        loadNotifications();
        loadStats();
        loadActivity();
      } catch (e) { showToast('Failed to send'); }
    }

    async function retrySend(id) { await sendOne(id); }

    async function sendAllPending() {
      try {
        const res = await fetch(API + '/api/notifications/actions/send-all-pending', { method: 'POST' });
        const data = await res.json();
        showToast(`Sent: ${data.sent}, Failed: ${data.failed}`);
        loadStats();
        loadActivity();
      } catch (e) { showToast('Failed to send all'); }
    }

    // ‚îÄ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadSettings() {
      try {
        const [connRes, tmplRes] = await Promise.all([
          fetch(API + '/api/connections'),
          fetch(API + '/api/template'),
        ]);
        const conn = await connRes.json();
        const tmpl = await tmplRes.json();

        document.getElementById('webhook-url').value = conn.spoke.webhookUrl || '‚Äî';
        document.getElementById('spoke-config-status').textContent = conn.spoke.configured ? '‚úì Configured' : '‚úó Missing API Key';
        document.getElementById('spoke-config-status').style.color = conn.spoke.configured ? '#2dd4bf' : '#ef4444';
        document.getElementById('quo-config-status').textContent = conn.quo.configured ? (conn.quo.live ? '‚úì Live' : '‚ö† Configured (unreachable)') : '‚úó Missing API Key';
        document.getElementById('quo-config-status').style.color = conn.quo.configured ? (conn.quo.live ? '#2dd4bf' : '#fbbf24') : '#ef4444';

        document.getElementById('template-display').textContent = tmpl.body || 'No template set';
        document.getElementById('template-input').value = tmpl.body || '';
      } catch (e) {
        console.error('Failed to load settings:', e);
      }
    }

    function toggleTemplateEdit() {
      const editor = document.getElementById('template-editor');
      editor.style.display = editor.style.display === 'none' ? '' : 'none';
    }

    async function saveTemplate() {
      const body = document.getElementById('template-input').value;
      try {
        await fetch(API + '/api/template', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ body }),
        });
        document.getElementById('template-display').textContent = body;
        document.getElementById('template-editor').style.display = 'none';
        showToast('Template saved');
      } catch (e) { showToast('Failed to save template'); }
    }

    // ‚îÄ‚îÄ‚îÄ Connection Check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function checkConnections() {
      try {
        const res = await fetch(API + '/api/connections');
        const conn = await res.json();

        const spokeDot = document.getElementById('spoke-dot');
        const spokeStatus = document.getElementById('spoke-status');
        spokeDot.className = 'conn-dot ' + (conn.spoke.configured ? 'live' : 'down');
        spokeStatus.className = 'conn-status ' + (conn.spoke.configured ? 'live' : 'down');
        spokeStatus.textContent = conn.spoke.configured ? 'Live' : 'Down';

        const quoDot = document.getElementById('quo-dot');
        const quoStatus = document.getElementById('quo-status');
        const quoOk = conn.quo.configured && conn.quo.live;
        quoDot.className = 'conn-dot ' + (quoOk ? 'live' : 'down');
        quoStatus.className = 'conn-status ' + (quoOk ? 'live' : 'down');
        quoStatus.textContent = quoOk ? 'Live' : (conn.quo.configured ? 'Error' : 'Down');
      } catch (e) {
        console.error('Connection check failed:', e);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Charts / Reports ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const chartDefaults = {
      color: '#94a3b8',
      borderColor: '#1e293b',
      font: { family: "'DM Sans', sans-serif" },
    };
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.borderColor = '#1e293b22';
    Chart.defaults.font.family = "'DM Sans', sans-serif";

    let dailyChart, responsesChart, storesChart, windowsChart;

    function destroyCharts() {
      [dailyChart, responsesChart, storesChart, windowsChart].forEach(c => { if (c) c.destroy(); });
    }

    async function loadCharts() {
      const days = document.getElementById('chart-days').value;
      try {
        const [dailyRes, responseRes, storeRes, windowRes] = await Promise.all([
          fetch(API + '/api/charts/daily?days=' + days),
          fetch(API + '/api/charts/responses'),
          fetch(API + '/api/charts/stores'),
          fetch(API + '/api/charts/time-windows'),
        ]);
        const daily = await dailyRes.json();
        const responses = await responseRes.json();
        const stores = await storeRes.json();
        const windows = await windowRes.json();

        // ‚îÄ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ‚îÄ
        const confirmRate = responses.total > 0 ? Math.round((responses.yes / responses.total) * 100) : 0;
        const declineRate = responses.total > 0 ? Math.round((responses.no / responses.total) * 100) : 0;
        const noReplyRate = responses.total > 0 ? Math.round((responses.noReply / responses.total) * 100) : 0;
        document.getElementById('kpi-confirm-rate').textContent = confirmRate + '%';
        document.getElementById('kpi-confirm-sub').textContent = `${responses.yes} of ${responses.total} sent`;
        document.getElementById('kpi-decline-rate').textContent = declineRate + '%';
        document.getElementById('kpi-decline-sub').textContent = `${responses.no} need rescheduling`;
        document.getElementById('kpi-reviews').textContent = responses.reviewsSent;
        document.getElementById('kpi-reviews-sub').textContent = 'Google review requests';
        document.getElementById('kpi-noreply').textContent = noReplyRate + '%';
        document.getElementById('kpi-noreply-sub').textContent = `${responses.noReply} no response`;

        destroyCharts();

        // ‚îÄ‚îÄ‚îÄ Daily Volume Chart (Bar) ‚îÄ‚îÄ‚îÄ
        const dailyLabels = daily.map(d => {
          const dt = new Date(d.date + 'T12:00:00');
          return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const dailyCtx = document.getElementById('chart-daily').getContext('2d');
        dailyChart = new Chart(dailyCtx, {
          type: 'bar',
          data: {
            labels: dailyLabels,
            datasets: [
              {
                label: 'Confirmed',
                data: daily.map(d => d.confirmed),
                backgroundColor: '#2dd4bf',
                borderRadius: 4,
                borderSkipped: false,
              },
              {
                label: 'Declined',
                data: daily.map(d => d.declined),
                backgroundColor: '#ef4444',
                borderRadius: 4,
                borderSkipped: false,
              },
              {
                label: 'No Reply',
                data: daily.map(d => d.total - d.confirmed - d.declined),
                backgroundColor: '#334155',
                borderRadius: 4,
                borderSkipped: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 10, padding: 16, font: { size: 11 } } },
            },
            scales: {
              x: { stacked: true, grid: { display: false }, ticks: { font: { size: 11 } } },
              y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } }, grid: { color: '#1e293b44' } },
            },
          },
        });

        // ‚îÄ‚îÄ‚îÄ Response Donut ‚îÄ‚îÄ‚îÄ
        const respCtx = document.getElementById('chart-responses').getContext('2d');
        responsesChart = new Chart(respCtx, {
          type: 'doughnut',
          data: {
            labels: ['Confirmed (YES)', 'Declined (NO)', 'Opted Out (STOP)', 'No Reply'],
            datasets: [{
              data: [responses.yes, responses.no, responses.stop, responses.noReply],
              backgroundColor: ['#2dd4bf', '#ef4444', '#64748b', '#334155'],
              borderWidth: 0,
              hoverOffset: 6,
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '62%',
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 10, padding: 14, font: { size: 11 } } },
              tooltip: {
                callbacks: {
                  label: function(ctx) {
                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                    const pct = total > 0 ? Math.round((ctx.raw / total) * 100) : 0;
                    return ` ${ctx.label}: ${ctx.raw} (${pct}%)`;
                  }
                }
              }
            },
          },
        });

        // ‚îÄ‚îÄ‚îÄ Store Breakdown (Horizontal Bar) ‚îÄ‚îÄ‚îÄ
        const storeCtx = document.getElementById('chart-stores').getContext('2d');
        const storeLabels = stores.map(s => storeNames[s.store] || s.store);
        const storeColorList = stores.map(s => storeColors[s.store] || '#64748b');
        storesChart = new Chart(storeCtx, {
          type: 'bar',
          data: {
            labels: storeLabels,
            datasets: [
              {
                label: 'Confirmed',
                data: stores.map(s => s.confirmed),
                backgroundColor: '#2dd4bf',
                borderRadius: 4,
                borderSkipped: false,
              },
              {
                label: 'Declined',
                data: stores.map(s => s.declined),
                backgroundColor: '#ef4444',
                borderRadius: 4,
                borderSkipped: false,
              },
              {
                label: 'Other',
                data: stores.map(s => s.total - s.confirmed - s.declined),
                backgroundColor: '#334155',
                borderRadius: 4,
                borderSkipped: false,
              },
            ],
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 10, padding: 16, font: { size: 11 } } },
            },
            scales: {
              x: { stacked: true, beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } }, grid: { color: '#1e293b44' } },
              y: { stacked: true, grid: { display: false }, ticks: { font: { size: 12, weight: 600 } } },
            },
          },
        });

        // ‚îÄ‚îÄ‚îÄ Time Windows (Polar Area) ‚îÄ‚îÄ‚îÄ
        const winCtx = document.getElementById('chart-windows').getContext('2d');
        const winColors = ['#2dd4bf', '#818cf8', '#fb923c', '#f472b6', '#a3e635', '#38bdf8', '#c084fc', '#fbbf24', '#ef4444', '#64748b'];
        windowsChart = new Chart(winCtx, {
          type: 'polarArea',
          data: {
            labels: windows.map(w => w.time_window.replace('between ', '')),
            datasets: [{
              data: windows.map(w => w.count),
              backgroundColor: windows.map((_, i) => winColors[i % winColors.length] + '99'),
              borderColor: windows.map((_, i) => winColors[i % winColors.length]),
              borderWidth: 1.5,
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 10, padding: 12, font: { size: 10 } } },
            },
            scales: {
              r: { ticks: { display: false }, grid: { color: '#1e293b44' }, beginAtZero: true },
            },
          },
        });

        // ‚îÄ‚îÄ‚îÄ Store Performance Table ‚îÄ‚îÄ‚îÄ
        const tbody = document.getElementById('store-perf-table');
        if (stores.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty">No store data yet</td></tr>';
        } else {
          tbody.innerHTML = stores.map(s => {
            const name = storeNames[s.store] || s.store;
            const color = storeColors[s.store] || '#64748b';
            const confirmPct = s.total > 0 ? Math.round((s.confirmed / s.total) * 100) : 0;
            const barWidth = Math.max(confirmPct, 4);
            return `<tr>
              <td><span class="store-dot"><span style="background:${color}"></span>${name}</span></td>
              <td style="font-weight:600;font-family:'JetBrains Mono',monospace">${s.total}</td>
              <td style="color:#2dd4bf;font-weight:600">${s.confirmed}</td>
              <td style="color:#ef4444;font-weight:600">${s.declined}</td>
              <td>
                <div style="display:flex;align-items:center;gap:8px">
                  <div style="flex:1;height:6px;background:#1e293b;border-radius:3px;overflow:hidden;max-width:80px">
                    <div style="width:${barWidth}%;height:100%;background:${confirmPct >= 70 ? '#2dd4bf' : confirmPct >= 40 ? '#fbbf24' : '#ef4444'};border-radius:3px"></div>
                  </div>
                  <span style="font-size:12px;font-weight:600;font-family:'JetBrains Mono',monospace">${confirmPct}%</span>
                </div>
              </td>
              <td style="color:#fbbf24;font-weight:600">${s.reviews_sent}</td>
            </tr>`;
          }).join('');
        }

      } catch (e) {
        console.error('Failed to load charts:', e);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    loadStats();
    loadActivity();
    checkConnections();

    // Refresh every 30 seconds
    setInterval(() => {
      loadStats();
      loadActivity();
      checkConnections();
    }, 30000);
  </script>
</body>
</html>
